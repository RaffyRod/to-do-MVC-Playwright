version: 2.1

jobs:
  test:
    docker:
      - image: mcr.microsoft.com/playwright:v1.40.0-focal
    working_directory: ~/repo
    environment:
      # Playwright browsers are pre-installed in Docker image
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: true
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
            - v1-dependencies-

      - run:
          name: Install Java and dependencies
          command: |
            echo "‚òï Installing Java for Allure..."
            apt-get update && apt-get install -y openjdk-11-jdk
            export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
            echo "JAVA_HOME=$JAVA_HOME" >> ~/.bashrc

            echo "üì¶ Installing dependencies..."
            npm ci
            echo "‚úÖ Dependencies installed successfully"

      - run:
          name: Run linter
          command: npm run lint

      - run:
          name: Verify Playwright browsers
          command: |
            echo "üîç Verifying Playwright browsers..."
            npx playwright --version
            echo "‚úÖ Browsers are pre-installed in Docker image"

      - run:
          name: Run Playwright tests and generate report
          command: |
            export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
            npm test
          when: on_success

      - run:
          name: Deploy to GitHub Pages
          command: |
            echo "üöÄ Starting GitHub Pages deployment..."

            # Install GitHub CLI
            if ! command -v gh &> /dev/null; then
              echo "üì¶ Installing GitHub CLI..."
              # Download and install GitHub CLI directly
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
              apt-get update && apt-get install gh -y
            fi

            # Configure git
            git config --global user.name "CircleCI"
            git config --global user.email "circleci@example.com"

            # Clone gh-pages branch
            echo "üì• Cloning gh-pages branch..."
            if [ -d "gh-pages" ]; then
              rm -rf gh-pages
            fi
            git clone --branch gh-pages --single-branch https://github.com/RaffyRod/to-do-MVC-Playwright.git gh-pages

            # Copy report files
            echo "üìã Copying report files..."
            cp -r allure-report/* gh-pages/

            # Commit and push
            echo "üíæ Committing changes..."
            cd gh-pages
            git add .
            git commit -m "Update test report - $(date)" || echo "No changes to commit"

            echo "üöÄ Pushing to GitHub Pages..."
            git remote set-url origin https://$GITHUB_TOKEN@github.com/RaffyRod/to-do-MVC-Playwright.git
            git push origin gh-pages

            echo "‚úÖ Successfully deployed to GitHub Pages!"
            echo "üåê Report available at: https://raffyrod.github.io/to-do-MVC-Playwright/"
          environment:
            GITHUB_TOKEN: $GITHUB_TOKEN
          when: always

      - store_artifacts:
          path: allure-report/
          destination: allure-report
          when: always

      - store_artifacts:
          path: test-results/
          destination: test-results
          when: always

      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package-lock.json" }}

workflows:
  test-and-deploy:
    jobs:
      - test:
          filters:
            branches:
              only: main
